<!DOCTYPE html>
<!-- saved from url=(0079)https://cssicurriculum.withgoogle.com/mvc-appEngine/users-api-lesson-notes.html -->
<html class="gr__cssicurriculum_withgoogle_com mdl-js"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width, initial-scale=1" name="viewport"><title>Users API</title><meta content="
          
              Users API
          " name="description"><link href="https://cssicurriculum.withgoogle.com/favicon.ico" rel="shortcut icon"><link href="./Users API_files/material.indigo-yellow.min.css" rel="stylesheet"><link href="./Users API_files/icon" rel="stylesheet"><script async="" src="./Users API_files/analytics.js.download"></script><script defer="" src="./Users API_files/material.min.js.download"></script><style>html,body{font-family:'Roboto','Helvetica',sans-serif;margin:0;padding:0}#verification_sent{display:None}.cssix-intro.mdl-card{width:99%;margin-bottom:2em}.cssix-intro.mdl-card>.mdl-card__supporting_text{padding:1em}.mdl-layout__header-row h3 a{color:white;text-decoration:none}#cssilogo_header{content:url('/cssilogo.png');width:80%}.admin_nav_link{color:red}.mdl-cssix .mdl-layout__header-row{padding-left:40px}.mdl-cssix .mdl-layout.is-small-screen .mdl-layout__header-row h3{font-size:inherit;padding-left:12px}.mdl-cssix .mdl-layout__tab-bar-button{display:none}.mdl-cssix .mdl-layout.is-small-screen .mdl-layout__tab-bar .mdl-button{display:none}.mdl-cssix .mdl-layout:not(.is-small-screen) .mdl-layout__tab-bar,.mdl-cssix .mdl-layout:not(.is-small-screen) .mdl-layout__tab-bar-container{overflow:visible}.cssi-main{overflow-x:visible!important;overflow-y:visible!important;overflow:visible!important}.mdl-cssix .mdl-layout__tab-bar-container{height:64px}.mdl-cssix .mdl-layout__tab-bar{padding:0;padding-left:16px;box-sizing:border-box;height:100%;width:100%}.mdl-cssix .mdl-layout__tab-bar .mdl-layout__tab{height:64px;line-height:64px;color:white}.mdl-cssix .mdl-layout__tab-bar .mdl-layout__tab.is-active::after{height:4px}.mdl-cssix main>.mdl-layout__tab-panel{padding:8px;padding-top:48px}.mdl-layout__tab#header_logout{background-color:red}.mdl-cssix .mdl-card{height:auto;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column}.mdl-cssix .mdl-card>*{height:auto}.mdl-cssix .mdl-card .mdl-card__supporting-text{margin:40px;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;padding:0;color:inherit;width:calc(100% - 80px)}.mdl-cssix .mdl-card__supporting-text h4{margin-top:0;margin-bottom:20px}.mdl-cssix .mdl-card__actions{margin:0;padding:4px 40px;color:inherit}.mdl-cssix .mdl-card__actions a{color:#00BCD4;margin:0}.mdl-cssix .mdl-card__actions a:hover,.mdl-cssix .mdl-card__actions a:active{color:inherit;background-color:transparent}.mdl-cssix .mdl-card__supporting-text+.mdl-card__actions{border-top:1px solid rgba(0,0,0,0.12)}.mdl-cssix #add{position:absolute;right:40px;top:36px;z-index:999}.mdl-list__item{min-height:.4em;padding:.3em}.material-icons.md-18{font-size:18px}.material-icons.md-24{font-size:24px}.material-icons.md-36{font-size:36px}.material-icons.md-48{font-size:48px}.post-list .toc_icon{vertical-align:middle;margin:.1em 1em}.mdl-cssix .mdl-layout__content section:not(:last-of-type){position:relative;margin-bottom:48px}.mdl-cssix section.section--center{max-width:860px}.mdl-cssix #features section.section--center{max-width:620px}.mdl-cssix section>header{display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-ms-flex-align:center;align-items:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center}.mdl-cssix section>.section__play-btn{min-height:200px}.mdl-cssix section>header>.material-icons{font-size:3rem}.mdl-cssix section>button{position:absolute;z-index:99;top:8px;right:8px}.mdl-cssix section .section__circle{display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-ms-flex-align:center;align-items:center;-webkit-justify-content:flex-start;-ms-flex-pack:start;justify-content:flex-start;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-shrink:1;-ms-flex-negative:1;flex-shrink:1}.mdl-cssix section .section__text{-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;padding-top:8px}.mdl-cssix section .section__text h5{font-size:inherit;margin:0;margin-bottom:.5em}.mdl-cssix section .section__text a{text-decoration:none}.mdl-cssix section .section__circle-container>.section__circle-container__circle{width:64px;height:64px;border-radius:32px;margin:8px 0}.mdl-cssix section.section--footer .section__circle--big{width:100px;height:100px;border-radius:50px;margin:8px 32px}.mdl-cssix .is-small-screen section.section--footer .section__circle--big{width:50px;height:50px;border-radius:25px;margin:8px 16px}.mdl-cssix section.section--footer{padding:64px 0;margin:0 -8px -8px -8px}.mdl-cssix section.section--center .section__text:not(:last-child){border-bottom:1px solid rgba(0,0,0,.13)}.mdl-cssix .mdl-card .mdl-card__supporting-text>h3:first-child{margin-bottom:24px}.mdl-cssix .mdl-layout__tab-panel:not(#overview){background-color:white}.mdl-cssix #features section{margin-bottom:72px}.mdl-cssix #features h4,#features h5{margin-bottom:16px}.mdl-cssix .toc{border-left:4px solid #C1EEF4;margin:24px;padding:0;padding-left:8px;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column}.mdl-cssix .toc h4{font-size:.9rem;margin-top:0}.mdl-cssix .toc a{color:#4DD0E1;text-decoration:none;font-size:16px;line-height:28px;display:block}.mdl-cssix .mdl-menu__container{z-index:99}.cssix-content{border-radius:2px;padding:80px 56px;margin-bottom:16px}.is-small-screen .cssix-content{padding:0 8px 16px 12px}.cssix-content a{color:#03a9f4!important}div.instructor{border:2px solid red;border-radius:12px;padding:10px}div.instructor::before{content:"Instructor Notes(The students will not see this content):";display:block;color:red;font-weight:bold}a.instructor-notes-link{color:green!important}div.unpublished{border:2px solid green;border-radius:12px;padding:10px;background-color:#deffd1}div.unpublished::before{content:"This content is not released to students yet";color:red;font-weight:bold}a.unpublished-link{color:red!important}a.next{float:right}.post-content img{width:50%;display:block;margin:auto}.post-content img.large_img{width:80%;display:block;margin:auto}.is-small-screen .mdl-layout__tab-bar-container{display:none}.mdl-layout.is-upgraded .mdl-layout__tab.is-active{color:yellow;font-weight:bold}.mdl-layout__tab.admin_link{background-color:#c71414}.mdl-layout__header .mdl-layout__drawer-button{color:yellow!important}. .mdl-mini-footer{border-top:1px solid #ccc;background-color:inherit!important;padding:8px 16px}footer .lockup{padding-left:15px;padding-top:10px}.lockup-logo,.lockup-text{display:inline-block}.va{vertical-align:middle;line-height:0}.lockup-logo{width:74px;height:24px;background-image:url(https://www.gstatic.com/images/branding/googlelogo/1x/googlelogo_color_74x24dp.png);background-size:74px 24px}.lockup-logo.lockup-dark{background-image:url(https://www.gstatic.com/images/branding/googlelogo/1x/googlelogo_dark_color_74x24dp.png);opacity:.54}@media(max-width:760px){footer .lockup{padding-top:0}}.answer{display:none;border:2px solid green;border-radius:12px;padding:1em}.hide_answer.mdl-button.mdl-js-button{display:none;!important}body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,hr,dl,dd,ol,ul,figure{margin:0;padding:0}body{font-family:Helvetica,Arial,sans-serif;font-size:16px;line-height:1.5;font-weight:300;color:#111;background-color:yellow;-webkit-text-size-adjust:100%}h1,h2,h3,h4,h5,h6,p,blockquote,pre,ul,ol,dl,figure,.highlight{margin-bottom:15px}img{max-width:100%;vertical-align:middle;display:block}figure>img{display:block}figcaption{font-size:14px}ul,ol{margin-left:30px}li>ul,li>ol{margin-bottom:0}h1,h2,h3,h4,h5,h6{font-weight:300}a{color:#2a7ae2;text-decoration:none}a:visited{color:#1756a9}a:hover{color:#111;text-decoration:underline}blockquote{color:#828282;border-left:4px solid #e8e8e8;padding-left:15px;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}pre,code{font-size:15px;border:1px solid #e8e8e8;border-radius:3px;background-color:#eef}code{padding:1px 5px}pre{padding:8px 12px;overflow-x:scroll}pre>code{border:0;padding-right:0;padding-left:0}.wrapper{max-width:-webkit-calc(800px -(30px * 2));max-width:calc(800px -(30px * 2));margin-right:auto;margin-left:auto;padding-right:30px;padding-left:30px}@media screen and (max-width:800px){.wrapper{max-width:-webkit-calc(800px -(30px));max-width:calc(800px -(30px));padding-right:15px;padding-left:15px}}.wrapper:after,.footer-col-wrapper:after{content:"";display:table;clear:both}.icon>svg{display:inline-block;width:16px;height:16px;vertical-align:middle}.icon>svg path{fill:#828282}.site-header{border-top:5px solid #424242;border-bottom:1px solid #e8e8e8;min-height:56px;position:relative}.site-title{font-size:26px;line-height:56px;letter-spacing:-1px;margin-bottom:0;float:left}.site-title,.site-title:visited{color:#424242}.sidebar-nav{float:left;border-right:1px solid #e8e8e8}.site-nav{float:right;line-height:56px}.site-nav .menu-icon{display:none}.site-nav .page-link{color:#111;line-height:1.5}.site-nav .page-link:not(:first-child){margin-left:20px}@media screen and (max-width:600px){.site-nav{position:absolute;top:9px;right:30px;background-color:yellow;border:1px solid #e8e8e8;border-radius:5px;text-align:right}.site-nav .menu-icon{display:block;float:right;width:36px;height:26px;line-height:0;padding-top:10px;text-align:center}.site-nav .menu-icon>svg{width:18px;height:15px}.site-nav .menu-icon>svg path{fill:#424242}.site-nav .trigger{clear:both;display:none}.site-nav:hover .trigger{display:block;padding-bottom:5px}.site-nav .page-link{display:block;padding:5px 10px}}.site-footer{border-top:1px solid #e8e8e8;padding:30px 0}.footer-heading{font-size:18px;margin-bottom:15px}.contact-list,.social-media-list{list-style:none;margin-left:0}.footer-col-wrapper{font-size:15px;color:#828282;margin-left:-15px}.footer-col{float:left;margin-bottom:15px;padding-left:15px}.footer-col-1{width:-webkit-calc(35% -(30px / 2));width:calc(35% -(30px / 2))}.footer-col-2{width:-webkit-calc(20% -(30px / 2));width:calc(20% -(30px / 2))}.footer-col-3{width:-webkit-calc(45% -(30px / 2));width:calc(45% -(30px / 2))}@media screen and (max-width:800px){.footer-col-1,.footer-col-2{width:-webkit-calc(50% -(30px / 2));width:calc(50% -(30px / 2))}.footer-col-3{width:-webkit-calc(100% -(30px / 2));width:calc(100% -(30px / 2))}}@media screen and (max-width:600px){.footer-col{float:none;width:-webkit-calc(100% -(30px / 2));width:calc(100% -(30px / 2))}}.page-content{padding:30px 0}.page-heading{font-size:20px}.post-list{margin-left:0;list-style:none;display:block;flex-wrap:wrap;justify-content:flex-start}.post-list>li{flex-basis:50%}.post-meta{font-size:14px;color:#828282}.post-link{display:block;font-size:1em}.post-header,.post-footer{margin-bottom:30px}.cssi-post-title{font-size:42px;letter-spacing:-1px;line-height:1}@media screen and (max-width:800px){.cssi-post-title{font-size:36px}}.cssix-intro h1{font-size:24px;line-height:1}.cssix-intro h2{font-size:16px;line-height:1}.post-content{margin-bottom:30px}.post-content h2{font-size:32px}@media screen and (max-width:800px){.post-content h2{font-size:28px}}.post-content h3{font-size:26px}@media screen and (max-width:800px){.post-content h3{font-size:22px}}.post-content h4{font-size:20px}@media screen and (max-width:800px){.post-content h4{font-size:18px}}.PageNavigation{font-size:14px;display:block;width:auto;overflow:hidden}.PageNavigation a{display:block;width:50%;float:left;margin:1em 0}.PageNavigation .next{text-align:right}.highlight .c{color:#998;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#998;font-style:italic}.highlight .cp{color:#999;font-weight:bold}.highlight .c1{color:#998;font-style:italic}.highlight .cs{color:#999;font-weight:bold;font-style:italic}.highlight .gd{color:#000;background-color:#fdd}.highlight .gd .x{color:#000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000;background-color:#dfd}.highlight .gi .x{color:#000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#458;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:#008080}.highlight .nb{color:#0086B3}.highlight .nc{color:#458;font-weight:bold}.highlight .no{color:#008080}.highlight .ni{color:#800080}.highlight .ne{color:#900;font-weight:bold}.highlight .nf{color:#900;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:#000080}.highlight .nv{color:#008080}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#d14}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#990073}.highlight .bp{color:#999}.highlight .vc{color:#008080}.highlight .vg{color:#008080}.highlight .vi{color:#008080}.highlight .il{color:#099}</style><link href="http://cssicurriculum.withgoogle.com/mvc-appEngine/users-api-lesson-notes.html" rel="canonical"><link href="http://cssicurriculum.withgoogle.com/feed.xml" rel="alternate" title="Google CSSI" type="application/rss+xml"></head><body class="mdl-color--grey-100 mdl-color-text--grey-700 mdl-cssix" data-gr-c-s-loaded="true"><div class="mdl-layout__container has-scrolling-header"><div class="mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--no-desktop-drawer-button has-drawer is-small-screen has-tabs is-upgraded" data-upgraded=",MaterialLayout"><header class="mdl-layout__header mdl-layout__header--scroll mdl-color--primary mdl-color-text--white"><div aria-expanded="false" role="button" tabindex="0" class="mdl-layout__drawer-button"><i class="material-icons"></i></div><div class="mdl-layout--large-screen-only mdl-layout__header-row"></div><div class="mdl-layout__header-row"><a href="https://cssicurriculum.withgoogle.com/" id="cssilogo_header"></a></div><div class="mdl-layout--large-screen-only mdl-layout__header-row"></div><div class="mdl-layout__tab-bar-container"><div class="mdl-layout__tab-bar-button mdl-layout__tab-bar-left-button"><i class="material-icons">chevron_left</i></div><div class="mdl-layout--large-screen-only mdl-layout__tab-bar mdl-js-ripple-effect mdl-color--primary-dark mdl-color-text--white mdl-js-ripple-effect--ignore-events" data-upgraded=",MaterialRipple"><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/intro.html">Intro<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/command-line.html">Command Line<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/html.html">HTML &amp; CSS<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/javascript.html">JavaScript<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/python.html">Python<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab is-active" href="https://cssicurriculum.withgoogle.com/app-engine.html">AppEngine<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/project.html">Project Week<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/git.html">Git<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/resources.html">Resources<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a></div><div class="mdl-layout__tab-bar-button mdl-layout__tab-bar-right-button"><i class="material-icons">chevron_right</i></div></div></header><div class="mdl-layout__drawer" aria-hidden="true"><span class="mdl-layout-title">CSSIx Modules</span><nav class="mdl-navigation"><a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/intro.html">Intro</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/command-line.html">Command Line</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/html.html">HTML &amp; CSS</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/javascript.html">JavaScript</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/python.html">Python</a> <a class="mdl-navigation__link is-active" href="https://cssicurriculum.withgoogle.com/app-engine.html">AppEngine</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/project.html">Project Week</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/git.html">Git</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/resources.html">Resources</a></nav></div><main class="mdl-layout__content cssi-main"><div class="mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"></div><div class="cssix-content mdl-color--white mdl-shadow--4dp content mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><div class="post"><header class="post-header"><div><div class="PageNavigation"><a class="prev" href="https://cssicurriculum.withgoogle.com/mvc-appEngine/apis-landing-page.html">« AppEngine Stretch - APIs in Action</a> <a class="next" href="https://cssicurriculum.withgoogle.com/mvc-appEngine/appEngine-API.html">App Engine and APIs Lecture Guide »</a></div></div></header><article class="post-content"><h1 id="users-api">Users API</h1><h2 id="framing">Framing</h2><p>There are lots of ways to create user accounts and store that information, but since information about users is generally sensitive, we need to be careful about what is stored, and how it’s stored.</p><p></p><h4 id="learning-objectives">Learning objectives</h4><ul><li>Add authentication using Google’s Users API</li><li>Register users by their Google Users nickname/email and store them in Datastore</li></ul><h4 id="sequence">Sequence</h4><ol><li><a href="https://cssicurriculum.withgoogle.com/mvc-appEngine/users-api-lesson-notes.html#getting-started">Getting Started</a></li><li><a href="https://cssicurriculum.withgoogle.com/mvc-appEngine/users-api-lesson-notes.html#users">Users API</a></li><li><a href="https://cssicurriculum.withgoogle.com/mvc-appEngine/users-api-lesson-notes.html#cssi-users">CSSI Users</a></li></ol><h2 id="getting-started">Getting started</h2><p>To start, set up a basic application.</p><p>In the <code class="highlighter-rouge">app.yaml</code> file:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="na">application</span><span class="pi">:</span> <span class="s">userapp</span>
<span class="na">version</span><span class="pi">:</span> <span class="s">1</span>
<span class="na">runtime</span><span class="pi">:</span> <span class="s">python27</span>
<span class="na">api_version</span><span class="pi">:</span> <span class="s">1</span>
<span class="na">threadsafe</span><span class="pi">:</span> <span class="s">yes</span>

<span class="na">handlers</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">url</span><span class="pi">:</span> <span class="s">/favicon\.ico</span>
  <span class="na">static_files</span><span class="pi">:</span> <span class="s">favicon.ico</span>
  <span class="na">upload</span><span class="pi">:</span> <span class="s">favicon\.ico</span>

<span class="pi">-</span> <span class="na">url</span><span class="pi">:</span> <span class="s">.*</span>
  <span class="na">script</span><span class="pi">:</span> <span class="s">main.app</span>

<span class="na">libraries</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webapp2</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2.5.2"</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>In the <code class="highlighter-rouge">main.py</code> file:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">webapp2</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Test successful"</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">WSGIApplication</span><span class="p">([</span>
  <span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">)</span>
<span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>Run the app locally as usual:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>dev_appserver.py app.yaml
</pre></td></tr></tbody></table></code></pre></div></div><p>So far, you’ll notice that all this is programmed to do is greet the user with the string <code class="highlighter-rouge">'Test successful'</code>. If that test works successfully in your browser, you’re ready to move ahead.</p><h2 id="users-api-1">Users API</h2><p>Because security is complex, there are entire careers devoted to creating safe login systems - most developers choose to use one of those pre-built login systems rather than engineering their own from scratch. This application will use the <a href="https://cloud.google.com/appengine/docs/standard/python/users/">Google Users API</a>.</p><h3 id="step-1-import-the-users-api">Step 1: Import the Users API.</h3><p>Add the following line of code right beneath the <code class="highlighter-rouge">import webapp2</code> statement:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">users</span>
</pre></td></tr></tbody></table></code></pre></div></div><h3 id="step-2-check-to-see-if-the-user-is-logged-in">Step 2: Check to see if the user is logged in.</h3><p>Modify your <code class="highlighter-rouge">get</code> route to check and respond differently depending on whether or not the user is logged in.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"You're logged in!"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"You're not logged in - please do so."</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>The Users api provides a function, <code class="highlighter-rouge">get_current_user()</code> which will return a <code class="highlighter-rouge">user</code> object if someone is logged in already. It will return <code class="highlighter-rouge">None</code> if the user has not logged in yet.</p><p>This is great, but if you test it, you’re probably only able to get one of these two responses - that’s because you don’t have the ability to log in or log out. The next two steps will add both those features.</p><h3 id="step-3-add-a-url-to-log-in">Step 3: Add a URL to log in.</h3><p>The “log in” link only needs to appear if the user isn’t yet logged in, so we’ll add that as part of the <code class="highlighter-rouge">else</code> piece of our route.</p><p>The Users API creates URLs to log in and out upon request. Here’s the code to create that URL:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"You're logged in!"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c"># This line creates a URL to log in with your Google Credentials.</span>
      <span class="n">login_url</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">create_login_url</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
      <span class="c"># This line uses string templating to create an anchor (link) element.</span>
      <span class="n">login_html_element</span> <span class="o">=</span> <span class="s">'&lt;a href="</span><span class="si">%</span><span class="s">s"&gt;Sign in&lt;/a&gt;'</span> <span class="o">%</span> <span class="n">login_url</span>
      <span class="c"># This line puts that URL on screen in a clickable anchor elememt.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'Please log in.&lt;b&gt;'</span> <span class="o">+</span> <span class="n">login_html_element</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>Notice a few things:</p><ul><li>We’re using string templating here to do all our coding in one file, but in a full-size app, it’d be smarter to jettison the HTML over to a Jinja2 template.</li><li>When you test this locally, it doesn’t look like a true Google login, and it doesn’t even ask for a password - you can type any email you want. Don’t worry - it’s designed that way for your convenience as a developer. When you deploy, the users API will use a more familiar Google login, and will require passwords.</li><li>The <code class="highlighter-rouge">users.create_login_url('/')</code> includes the argument <code class="highlighter-rouge">'/'</code>, which is a redirect. It just means that once the user does log in, they will be redirected to the <code class="highlighter-rouge">/</code> route, which we can think of as the homepage route. Since the <code class="highlighter-rouge">MainHandler</code> where we are writing this code <em>is</em> the homepage route, that means after the user logs in, the program goes back to the top of the code for the <code class="highlighter-rouge">MainHandler</code>, but this time with a current user logged in.</li></ul><h3 id="step-4-add-a-url-to-log-out">Step 4: Add a URL to log out.</h3><p>Logging in is good, but frustrating without a log out function as well. The log out functionality is almost identical to the login functionality. Here’s what that looks like.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
      <span class="c"># The if block only runs if the user IS logged in.</span>
      <span class="c"># The user has a method called `nickname()` that looks up their email.</span>
      <span class="c"># We can use this information to show the user who they're logged in as.</span>
      <span class="n">email_address</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">nickname</span><span class="p">()</span>
      <span class="c"># Generate a sign out link - this does it all in one line.</span>
      <span class="n">logout_link_html</span> <span class="o">=</span> <span class="s">'&lt;a href="</span><span class="si">%</span><span class="s">s"&gt;sign out&lt;/a&gt;'</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">users</span><span class="o">.</span><span class="n">create_logout_url</span><span class="p">(</span><span class="s">'/'</span><span class="p">))</span>
      <span class="c"># Show that sign out link on screen:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="s">"You're logged in as "</span> <span class="o">+</span> <span class="n">email_address</span> <span class="o">+</span> <span class="s">"&lt;br&gt;"</span> <span class="o">+</span> <span class="n">logout_link_html</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c"># The else block only runs if the user isn't logged in.</span>
      <span class="n">login_url</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">create_login_url</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
      <span class="n">login_html_element</span> <span class="o">=</span> <span class="s">'&lt;a href="</span><span class="si">%</span><span class="s">s"&gt;Sign in&lt;/a&gt;'</span> <span class="o">%</span> <span class="n">login_url</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'Please log in.&lt;br&gt;'</span> <span class="o">+</span> <span class="n">login_html_element</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>Now that the app verifies users through the Users API, it’s time to think about how we can use that to keep track of who is using our site.</p><h2 id="cssi-users">CSSI Users</h2><p>For privacy reasons, the pre-built <code class="highlighter-rouge">User</code> class that we have access to through the Users API only gives us access to basic information about the user: their email and a numeric id. That’s a start, but we’re also going to want store information about users who visit our site. For example, if our app serves funny memes, we may want to store their preferences and favorite meme characters.</p><p>We’ll create a <code class="highlighter-rouge">CssiUser</code> class, which will allow users to register on our site, and then when someone logs in through Google, our server can check their email against our database. If they’re already registered, we can access additional information about them (like their name). If they aren’t, we can create a <code class="highlighter-rouge">CssiUser</code> Entity to store info about them.</p><h3 id="step-5-define-the-cssiuser-kind">Step 5: Define the <code class="highlighter-rouge">CssiUser</code> Kind.</h3><p>To store information about our users in Datastore, we’ll need a Kind, just like we’ve used for storing other information. Each of our <code class="highlighter-rouge">CssiUser</code> Entities will have three properties: an email, a first name, and a a last name. Here’s what that looks like.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">webapp2</span>

<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">users</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">ndb</span>

<span class="k">class</span> <span class="nc">CssiUser</span><span class="p">(</span><span class="n">ndb</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="n">first_name</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>
  <span class="n">last_name</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>
  <span class="n">email</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="o">...</span>
</pre></td></tr></tbody></table></code></pre></div></div><h3 id="step-6-check-to-see-if-the-users-email-is-in-the-datastore">Step 6: Check to see if the user’s email is in the Datastore.</h3><p>Now that the user Kind has been defined, we can cross reference a Google user’s email with a CSSI User’s email using the <code class="highlighter-rouge">user.nickname()</code> method from Google, and the <code class="highlighter-rouge">CssiUser.email</code> from the user profiles we create. A simple query can determine whether or not the user has registered before, and then the app can respond differently based on whether or not this user has registered.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
      <span class="c"># Create the sign out link (for later use).</span>
      <span class="n">signout_link_html</span> <span class="o">=</span> <span class="s">'&lt;a href="</span><span class="si">%</span><span class="s">s"&gt;sign out&lt;/a&gt;'</span> <span class="o">%</span> <span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">create_logout_url</span><span class="p">(</span><span class="s">'/'</span><span class="p">))</span>
      <span class="c"># If the user is logged in, get their email address.</span>
      <span class="n">email_address</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">nickname</span><span class="p">()</span>
      <span class="c"># Then query Datastore to see if a user with this email has registered as</span>
      <span class="c"># a CssiUser before.</span>
      <span class="n">cssi_user</span> <span class="o">=</span> <span class="n">CssiUser</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">CssiUser</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email_address</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
      <span class="c"># If the query is successful, the variable will have a user in it, so the</span>
      <span class="c"># following code will run.</span>
      <span class="k">if</span> <span class="n">cssi_user</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
          <span class="s">"Looks like you're registered. Thanks for using our site!"</span><span class="p">)</span>
      <span class="c"># if the query wasn't successful, the variable will be empty, so this code</span>
      <span class="c"># will run instead.</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
          <span class="s">"Looks like you aren't a CSSI User. Please sign up."</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c"># If the user isn't logged in...</span>
      <span class="n">login_url</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">create_login_url</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
      <span class="n">login_html_element</span> <span class="o">=</span> <span class="s">'&lt;a href="</span><span class="si">%</span><span class="s">s"&gt;Sign in&lt;/a&gt;'</span> <span class="o">%</span> <span class="n">login_url</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'Please log in.&lt;br&gt;'</span> <span class="o">+</span> <span class="n">login_html_element</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>Note that <code class="highlighter-rouge">.get()</code>, which has previously been reserved for keys, also works on queries. We’ve previously relied on <code class="highlighter-rouge">.fetch()</code> with queries, which return a <em>list</em> of Entities. Just be sure to remember that when used with queries, <code class="highlighter-rouge">.get()</code> returns exactly one single Entity (the first match for the query), if one is found. If no matches are found, <code class="highlighter-rouge">.get()</code> will return <code class="highlighter-rouge">None</code> instead.</p><p>For our purposes, the <code class="highlighter-rouge">.get()</code> behavior matches the behavior we need. If a <code class="highlighter-rouge">CssiUser</code> is found, do one thing, and if none is found, do the other.</p><p></p><h3 id="step-7-create-an-option-to-sign-up-for-cssi">Step 7: Create an option to sign up for CSSI.</h3><p>If a user isn’t yet registered, we need a way for them to do that. Let’s give them the option with a form:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
      <span class="n">signout_link_html</span> <span class="o">=</span> <span class="s">'&lt;a href="</span><span class="si">%</span><span class="s">s"&gt;sign out&lt;/a&gt;'</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">users</span><span class="o">.</span><span class="n">create_logout_url</span><span class="p">(</span><span class="s">'/'</span><span class="p">))</span>
      <span class="n">email_address</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">nickname</span><span class="p">()</span>
      <span class="n">cssi_user</span> <span class="o">=</span> <span class="n">CssiUser</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">CssiUser</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email_address</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">cssi_user</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
          <span class="s">"Looks like you're registered. Thanks for using our site!"</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c"># Registration form for a first-time visitor:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'''
            Welcome to our site, </span><span class="si">%</span><span class="s">s!  Please sign up! &lt;br&gt;
            &lt;form method="post" action="/"&gt;
            &lt;input type="text" name="first_name"&gt;
            &lt;input type="text" name="last_name"&gt;
            &lt;input type="submit"&gt;
            &lt;/form&gt;&lt;br&gt; </span><span class="si">%</span><span class="s">s &lt;br&gt;
            '''</span> <span class="o">%</span> <span class="p">(</span><span class="n">email_address</span><span class="p">,</span> <span class="n">signout_link_html</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="c"># If the user isn't logged in...</span>
      <span class="n">login_url</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">create_login_url</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
      <span class="n">login_html_element</span> <span class="o">=</span> <span class="s">'&lt;a href="</span><span class="si">%</span><span class="s">s"&gt;Sign in&lt;/a&gt;'</span> <span class="o">%</span> <span class="n">login_url</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'Please log in.&lt;br&gt;'</span> <span class="o">+</span> <span class="n">login_html_element</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>Notice a few things:</p><ul><li>The form is set to <code class="highlighter-rouge">post</code> to the <code class="highlighter-rouge">/</code> route - our app isn’t configured for that yet, so this form will probably cause an error if you use it without the next step.</li><li>As before, this is definitely better accomplished through a Jinja2 template, but it’s kept as a simple string here so it can all be read at once. When building your own apps, pass the variables to the <code class="highlighter-rouge">render_template()</code> method instead.</li><li>We use the <code class="highlighter-rouge">'''</code> triple quotation mark to write strings that span across multiple lines of code. The code could still run if we wrote it all in one line, but most companies have strict rules about how long each line of code is allowed to be, and this helps us follow those rules (and makes our code much easier to read).</li></ul><p></p><h3 id="step-8-handle-post-requests-to-sign-up">Step 8: Handle POST requests to sign up.</h3><p>Since the form is set to <code class="highlighter-rouge">post</code> to the <code class="highlighter-rouge">/</code> route, it’s time to add a post method to our <code class="highlighter-rouge">MainHandler</code></p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="o">...</span>

  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="c"># Create a new CSSI user.</span>
    <span class="n">cssi_user</span> <span class="o">=</span> <span class="n">CssiUser</span><span class="p">(</span>
        <span class="n">first_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'first_name'</span><span class="p">),</span>
        <span class="n">last_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'last_name'</span><span class="p">),</span>
        <span class="n">email</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">nickname</span><span class="p">())</span>
    <span class="c"># Store that Entity in Datastore.</span>
    <span class="n">cssi_user</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
    <span class="c"># Show confirmation to the user. Include a link back to the index.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'Thanks for signing up, </span><span class="si">%</span><span class="s">s! &lt;br&gt;&lt;a href="/"&gt;Home&lt;/a&gt;'</span> <span class="o">%</span>
        <span class="n">cssi_user</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>Note that the first and last names are coming from the request, which has the form data from when the user registered for our site. The email is accessed from the Users API - remember that for privacy reasons, not much is available from the Users API, but a user’s email is available using the <code class="highlighter-rouge">.nickname()</code> method.</p><h6 id="mini-challenge-optional">Mini-challenge (optional)</h6><p>You may also want to add in some error handling in case someone tries to get here without logging in first. If the <code class="highlighter-rouge">user.nickname()</code> method runs when no user is logged in, the visitor to your site will see an “internal server error” message, which isn’t what is actually happening.</p><p>Instead, we want the user to know that they’re attempting to access a site they shouldn’t be able to access without first logging in.</p><p>First, add some <code class="highlighter-rouge">if-else</code> control flow to your handler.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="o">...</span>

  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
      <span class="c"># You shouldn't be able to get here without being logged in</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="o">...</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>It will be really hard for a user to get here without logging in, since they have to be logged in to access the form in the first place, but just in case, we’ve added a redirect to send them back to the main page.</p><h3 id="step-9-display-information-about-a-logged-in-google-user-who-is-also-a-cssiuser">Step 9: Display information about a logged-in Google User who is also a CssiUser.</h3><p>Right now, a user who has successfully logged in and registered for this app gets an unsatisfying response:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Looks like you're registered. Thanks for using our site!"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>Let’s refactor that part of our app to be more dynamic.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="n">cssi_user</span><span class="p">:</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'''
    Welcome </span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s (</span><span class="si">%</span><span class="s">s)! &lt;br&gt; </span><span class="si">%</span><span class="s">s &lt;br&gt;'''</span> <span class="o">%</span> <span class="p">(</span>
      <span class="n">cssi_user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
      <span class="n">cssi_user</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
      <span class="n">email_address</span><span class="p">,</span>
      <span class="n">signout_link_html</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>In context, here’s what the completed app might look like.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">webapp2</span>

<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">users</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">ndb</span>

<span class="k">class</span> <span class="nc">CssiUser</span><span class="p">(</span><span class="n">ndb</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="n">first_name</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>
  <span class="n">last_name</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>
  <span class="n">email</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="c"># If the user is logged in...</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
      <span class="n">signout_link_html</span> <span class="o">=</span> <span class="s">'&lt;a href="</span><span class="si">%</span><span class="s">s"&gt;sign out&lt;/a&gt;'</span> <span class="o">%</span> <span class="p">(</span>
          <span class="n">users</span><span class="o">.</span><span class="n">create_logout_url</span><span class="p">(</span><span class="s">'/'</span><span class="p">))</span>
      <span class="n">email_address</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">nickname</span><span class="p">()</span>
      <span class="n">cssi_user</span> <span class="o">=</span> <span class="n">CssiUser</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">CssiUser</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email_address</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
      <span class="c"># If the user is registered...</span>
      <span class="k">if</span> <span class="n">cssi_user</span><span class="p">:</span>
        <span class="c"># Greet them with their personal information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'''
            Welcome </span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s (</span><span class="si">%</span><span class="s">s)! &lt;br&gt; </span><span class="si">%</span><span class="s">s &lt;br&gt;'''</span> <span class="o">%</span> <span class="p">(</span>
              <span class="n">cssi_user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
              <span class="n">cssi_user</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
              <span class="n">email_address</span><span class="p">,</span>
              <span class="n">signout_link_html</span><span class="p">))</span>
      <span class="c"># If the user isn't registered...</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c"># Offer a registration form for a first-time visitor:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'''
            Welcome to our site, </span><span class="si">%</span><span class="s">s!  Please sign up! &lt;br&gt;
            &lt;form method="post" action="/"&gt;
            &lt;input type="text" name="first_name"&gt;
            &lt;input type="text" name="last_name"&gt;
            &lt;input type="submit"&gt;
            &lt;/form&gt;&lt;br&gt; </span><span class="si">%</span><span class="s">s &lt;br&gt;
            '''</span> <span class="o">%</span> <span class="p">(</span><span class="n">email_address</span><span class="p">,</span> <span class="n">signout_link_html</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c"># If the user isn't logged in...</span>
      <span class="n">login_url</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">create_login_url</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
      <span class="n">login_html_element</span> <span class="o">=</span> <span class="s">'&lt;a href="</span><span class="si">%</span><span class="s">s"&gt;Sign in&lt;/a&gt;'</span> <span class="o">%</span> <span class="n">login_url</span>
      <span class="c"># Prompt the user to sign in.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'Please log in.&lt;br&gt;'</span> <span class="o">+</span> <span class="n">login_html_element</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># Code to handle a first-time registration from the form:</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="n">cssi_user</span> <span class="o">=</span> <span class="n">CssiUser</span><span class="p">(</span>
        <span class="n">first_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'first_name'</span><span class="p">),</span>
        <span class="n">last_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'last_name'</span><span class="p">),</span>
        <span class="n">email</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">nickname</span><span class="p">())</span>
    <span class="n">cssi_user</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'Thanks for signing up, </span><span class="si">%</span><span class="s">s! &lt;br&gt;&lt;a href="/"&gt;Home&lt;/a&gt;'</span> <span class="o">%</span>
        <span class="n">cssi_user</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">WSGIApplication</span><span class="p">([</span>
  <span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">)</span>
<span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></pre></div></div><h3 id="step-10-use-the-users-api-to-gate-certain-pages">Step 10: Use the Users API to gate certain pages.</h3><p>Now that we have logins and registration implemented, let’s consider how we would use a check for login status to prevent an unauthorized user from accessing content we don’t want them to access. Let’s start by creating that content. Make a new route and a corresponding handler.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">SecretHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"You found the secret content!"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="o">...</span> <span class="c"># skipping our code from earlier, since it is quite long now.</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">WSGIApplication</span><span class="p">([</span>
  <span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">'/classified'</span><span class="p">,</span> <span class="n">SecretHandler</span><span class="p">)</span>
<span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>Right now, any user could access this content by typing <code class="highlighter-rouge">/classified</code> at the end of your site’s URL. So now let’s add logic to confirm that they are logged in first.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">SecretHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"You found the secret content!"</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></pre></div></div><p>So far this only checks to make sure they’re logged in to the Users API. Let’s also add a check to make sure they’re a CSSI user.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">SecretHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
      <span class="n">email_address</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">nickname</span><span class="p">()</span>
      <span class="n">cssi_user</span> <span class="o">=</span> <span class="n">CssiUser</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">CssiUser</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email_address</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">cssi_user</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"You found the secret content!"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c"># If either above condition is not met, this line will run instead:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Sorry, this page is only for CSSI users."</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>The best way to do this is with a 403 or “forbidden” error.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">SecretHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
      <span class="n">email_address</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">nickname</span><span class="p">()</span>
      <span class="n">cssi_user</span> <span class="o">=</span> <span class="n">CssiUser</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">CssiUser</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email_address</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">cssi_user</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"You found the secret content!"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
    <span class="k">return</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>Once you’ve got this working so that it only allows logged-in and registered users to see the secret content, consider making a <a href="https://dribbble.com/tags/403">403 page</a> to inform the user that they are trying to access a forbidden page in a more interesting way. Add a URL for them to login using the <code class="highlighter-rouge">.create_login_url('/')</code> method.</p><h3 id="step-11-integrate-this-procedure-into-your-application">Step 11: Integrate this procedure into your application.</h3><p>This may seem like a lot of new information, but the Users API has really only added four new methods to our code: <code class="highlighter-rouge">.get_current_user()</code>, <code class="highlighter-rouge">.nickname()</code>, <code class="highlighter-rouge">.create_login_url()</code>, and <code class="highlighter-rouge">.create_logout_url()</code>. The rest of what we’ve covered here is really just putting together everything else we’ve learned so far.</p><p>Now that you have successfully added login and sign up features to this sample app, it’s time to think about more robust implementations. Here are some great next steps to work on making this integration more similar to what we see in apps in production:</p><ul><li>Add HTML templates and use the <code class="highlighter-rouge">render_template()</code> function to create the responses.</li><li>Add a form for the user to be able to update their first or last names.</li><li>Add additional properties to the <code class="highlighter-rouge">CssiUser</code> class.</li><li>Add a forum template, an link on the homepage, and a handler for logged-in users to get there. Add another Datastore Kind for messages, and allow users to create messages which are posted to the forum.</li></ul></article><footer class="post-footer"><hr><div class="PageNavigation"><a class="prev" href="https://cssicurriculum.withgoogle.com/mvc-appEngine/apis-landing-page.html">« AppEngine Stretch - APIs in Action</a> <a class="next" href="https://cssicurriculum.withgoogle.com/mvc-appEngine/appEngine-API.html">App Engine and APIs Lecture Guide »</a></div></footer></div></div></div></main><footer class="mdl-mini-footer section"><div class="mdl-mini-footer__left-section"><div class="lockup va"><span class="lockup-logo lockup-dark"></span></div></div><div class="mdl-mini-footer__right-section"><ul class="mdl-mini-footer__link-list"><li><span id="site_label">CSSI - Atlanta</span></li><li>--</li><li><a href="https://www.google.com/intl/en/about/">About Google</a></li><li><a href="https://www.google.com/intl/en/policies/privacy/">Privacy</a></li><li><a href="https://www.google.com/intl/en/policies/terms/">Terms</a></li><li><a href="https://cssicurriculum.withgoogle.com/mvc-appEngine/users-api-lesson-notes.html#" id="signout_link">Logout</a></li><li><a href="https://cssicurriculum.withgoogle.com/mvc-appEngine/users-api-lesson-notes.html#" id="forgetme_link">Forget Me</a></li></ul></div><script src="./Users API_files/firebase-app.js.download"></script><script src="./Users API_files/firebase-auth.js.download"></script><script src="./Users API_files/firebaseui.js.download"></script><link href="./Users API_files/firebaseui.css" rel="stylesheet" type="text/css"><script>
  function getCookie(name) {
    let dc = document.cookie;
    let prefix = name + "=";
    let begin = dc.indexOf("; " + prefix);
    if (begin == -1) {
      begin = dc.indexOf(prefix);
      if (begin != 0) return null;
    }
    begin += 2;
    let end = document.cookie.indexOf(";", begin);
    if (end == -1) {
      end = dc.length;
    }
    return decodeURI(dc.substring(begin + prefix.length, end));
  }

  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyD_NpvZGlms1zebBgfE4RZPCim5irYGbG4",
    authDomain: "cssi-curriculum.firebaseapp.com",
    databaseURL: "https://cssi-curriculum.firebaseio.com",
    projectId: "cssi-curriculum",
    storageBucket: "cssi-curriculum.appspot.com",
    messagingSenderId: "443846997353"
  };
  // Firebase log-in widget
  function configureFirebaseLoginWidget() {
    let uiConfig = {
      signInSuccessUrl: '/',
      signInOptions: [
        // Leave the lines as is for the providers you want to offer your users.
        firebase.auth.GoogleAuthProvider.PROVIDER_ID,
        {
            provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
            // Whether the display name should be displayed in the Sign Up page.
            requireDisplayName: false,
        },
      ],
      callbacks: {
        signInSuccessWithAuthResult: function(authResult, redirectUrl) {
          let user = authResult.user;
          let credential = authResult.credential;
          let isNewUser = authResult.additionalUserInfo.isNewUser;
          let providerId = authResult.additionalUserInfo.providerId;
          let operationType = authResult.operationType;
          // Do something with the returned AuthResult.
          // Return type determines whether we continue the redirect automatically
          // or whether we leave that to developer to handle.
          return true;
        },
        signInFailure: function(error) {
          // Some unrecoverable error occurred during sign-in.
          // Return a promise when error handling is completed and FirebaseUI
          // will reset, clearing any UI. This commonly occurs for error code
          // 'firebaseui/anonymous-upgrade-merge-conflict' when merge conflict
          // occurs. Check below for more details on this.
          return handleUIError(error);
        },
      },
      // Terms of service url
      'tosUrl': 'https://www.google.com/intl/en/policies/terms/',
    };

    let user = firebase.auth().currentUser;
    if (!user && document.getElementById('firebaseui-auth-container')) {
      let ui = new firebaseui.auth.AuthUI(firebase.auth());
      ui.start('#firebaseui-auth-container', uiConfig);
    }
  }

  function updateUserToken(user) {
    let oldCookie = getCookie('idToken');
    if (user) {
      let refresh_token = getCookie('needRefreshToken');
      user.getIdToken(refresh_token == 'true').then(function(idToken) {
        document.cookie = "idToken=" + idToken + "; path=/";
        if (!oldCookie) {
          location.reload();
        }
      });
    } else {
      console.log("Removing auth token");
      document.cookie = "idToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC";
      if (oldCookie) {
        location.reload();
      }
    }
  }

  function configureFirebaseLogin() {
    firebase.initializeApp(config);
    firebase.auth().onAuthStateChanged(updateUserToken);
    firebase.auth().onIdTokenChanged(function() {console.log("token changed");});
  }

  function signOut() {
    firebase.auth().signOut();
    window.location = "/";
    return false;
  }

  function forgetMe() {
    let user = firebase.auth().currentUser;
    user.delete().then(function() {
      console.log("User deleted");
    }).catch(function(error) {
      console.log("Error deleting the user " + error);
    });
    firebase.auth().signOut();
    window.location = "/";
    return false;
  }

  function sendVerificationEmail() {
    let user = firebase.auth().currentUser;
    if (user && !user.emailVerified) {
      user.sendEmailVerification().then(function() {
          console.log("Verification email sent.");
        }).catch(function(error) {
          console.log("An error happened while sending the verification email.");
        });
    } else if (user) {
      console.log("Email already verified");
    } else {
      console.log("User not logged in");
    }
    console.log("Removing auth token");
    document.cookie = "idToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
    document.querySelector('#send_verification_button').style.display = 'None';
    document.querySelector('#verification_sent').style.display = 'block';
  }

  function checkAndRestoreCookie(){
    let user = firebase.auth().currentUser;
  }

  function showAnswer(event) {
    let show_answer_button = event.currentTarget;
    let answer_container = show_answer_button.parentElement;
    toggleAnswer(answer_container, true);
  }

  function hideAnswer(event) {
    let show_answer_button = event.currentTarget;
    let answer_container = show_answer_button.parentElement;
    toggleAnswer(answer_container, false);
  }

  function toggleAnswer(container, visible) {
    let answer = container.querySelector('.answer');
    answer.style.display = visible ? 'block' : 'none';
    let hide_answer_button = container.querySelector('.hide_answer');
    hide_answer_button.style.display = visible ? 'block' : 'none';
    let show_answer_button = container.querySelector('.show_answer');
    show_answer_button.style.display = visible ? 'none' : 'block';
  }

  function toggleStudentViewCookie(event) {
    const new_value = event.target.checked;
    document.cookie = "student_view=" + new_value + ";path=/";
    location.reload();
  }

  window.addEventListener('load', function() {
    configureFirebaseLogin();
    configureFirebaseLoginWidget();
    //checkAndRestoreCookie();
    let signout_link = document.querySelector('#signout_link');
    if (signout_link) {
      signout_link.onclick = signOut;
    }
    let forgetme_link = document.querySelector('#forgetme_link');
    if (forgetme_link) {
      forgetme_link.onclick = forgetMe;
    }
    let email_verification_btn = document.querySelector('#send_verification_button');
    if (email_verification_btn) {
      email_verification_btn.onclick = sendVerificationEmail;
    }
    let show_answer_btns = document.querySelectorAll('.show_answer');
    show_answer_btns.forEach( function(element) {
      element.onclick = showAnswer;
    });
    let hide_answer_btns = document.querySelectorAll('.hide_answer');
    hide_answer_btns.forEach( function(element) {
      element.onclick = hideAnswer;
    });
    // Student View checkbox not available on all pages, if present,
    // it can be used to override the user role, so that instructors can view
    // content as students.
    let student_view_flag = document.querySelector('#chk_student_view');
    if (student_view_flag) {
      student_view_flag.checked = JSON.parse(getCookie('student_view'));
      student_view_flag.onclick = toggleStudentViewCookie;
    }
    // Select the proper element in the site selection view based on the
    // existing cookies.
    let selected_site = getCookie('site');
    let site_selector_list = document.querySelectorAll('.site_radio');
    [].forEach.call(site_selector_list, (element) => {
      element.addEventListener('click', () => {
        console.log('Clicked ' + element.value);
        document.cookie = "site=" + element.value + ";path=/";
        document.querySelector('#site_label').innerText = element.dataset.label;
      });
    });
    if (selected_site && site_selector_list.length > 0) {
      [].forEach.call(site_selector_list, (element) => {
        console.log(selected_site);
        if (element.value === selected_site) {
          element.checked = true;
        } else {
          element.checked = false;
        }
      });
      console.log(site_selector_list);
    }

  })
</script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-101261509-1', 'auto');
  ga('send', 'pageview');
</script></footer><div class="mdl-layout__obfuscator"></div></div></div></body></html>