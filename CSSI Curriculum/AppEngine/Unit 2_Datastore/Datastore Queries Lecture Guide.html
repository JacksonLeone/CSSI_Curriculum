<!DOCTYPE html>
<!-- saved from url=(0085)https://cssicurriculum.withgoogle.com/mvc-appEngine/datastore-query-relationship.html -->
<html class="gr__cssicurriculum_withgoogle_com mdl-js"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width, initial-scale=1" name="viewport"><title>Datastore Queries Lecture Guide</title><meta content="
          
              Datastore Queries Lecture Guide
          " name="description"><link href="https://cssicurriculum.withgoogle.com/favicon.ico" rel="shortcut icon"><link href="./Datastore Queries Lecture Guide_files/material.indigo-yellow.min.css" rel="stylesheet"><link href="./Datastore Queries Lecture Guide_files/icon" rel="stylesheet"><script async="" src="./Datastore Queries Lecture Guide_files/analytics.js.download"></script><script defer="" src="./Datastore Queries Lecture Guide_files/material.min.js.download"></script><style>html,body{font-family:'Roboto','Helvetica',sans-serif;margin:0;padding:0}#verification_sent{display:None}.cssix-intro.mdl-card{width:99%;margin-bottom:2em}.cssix-intro.mdl-card>.mdl-card__supporting_text{padding:1em}.mdl-layout__header-row h3 a{color:white;text-decoration:none}#cssilogo_header{content:url('/cssilogo.png');width:80%}.admin_nav_link{color:red}.mdl-cssix .mdl-layout__header-row{padding-left:40px}.mdl-cssix .mdl-layout.is-small-screen .mdl-layout__header-row h3{font-size:inherit;padding-left:12px}.mdl-cssix .mdl-layout__tab-bar-button{display:none}.mdl-cssix .mdl-layout.is-small-screen .mdl-layout__tab-bar .mdl-button{display:none}.mdl-cssix .mdl-layout:not(.is-small-screen) .mdl-layout__tab-bar,.mdl-cssix .mdl-layout:not(.is-small-screen) .mdl-layout__tab-bar-container{overflow:visible}.cssi-main{overflow-x:visible!important;overflow-y:visible!important;overflow:visible!important}.mdl-cssix .mdl-layout__tab-bar-container{height:64px}.mdl-cssix .mdl-layout__tab-bar{padding:0;padding-left:16px;box-sizing:border-box;height:100%;width:100%}.mdl-cssix .mdl-layout__tab-bar .mdl-layout__tab{height:64px;line-height:64px;color:white}.mdl-cssix .mdl-layout__tab-bar .mdl-layout__tab.is-active::after{height:4px}.mdl-cssix main>.mdl-layout__tab-panel{padding:8px;padding-top:48px}.mdl-layout__tab#header_logout{background-color:red}.mdl-cssix .mdl-card{height:auto;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column}.mdl-cssix .mdl-card>*{height:auto}.mdl-cssix .mdl-card .mdl-card__supporting-text{margin:40px;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;padding:0;color:inherit;width:calc(100% - 80px)}.mdl-cssix .mdl-card__supporting-text h4{margin-top:0;margin-bottom:20px}.mdl-cssix .mdl-card__actions{margin:0;padding:4px 40px;color:inherit}.mdl-cssix .mdl-card__actions a{color:#00BCD4;margin:0}.mdl-cssix .mdl-card__actions a:hover,.mdl-cssix .mdl-card__actions a:active{color:inherit;background-color:transparent}.mdl-cssix .mdl-card__supporting-text+.mdl-card__actions{border-top:1px solid rgba(0,0,0,0.12)}.mdl-cssix #add{position:absolute;right:40px;top:36px;z-index:999}.mdl-list__item{min-height:.4em;padding:.3em}.material-icons.md-18{font-size:18px}.material-icons.md-24{font-size:24px}.material-icons.md-36{font-size:36px}.material-icons.md-48{font-size:48px}.post-list .toc_icon{vertical-align:middle;margin:.1em 1em}.mdl-cssix .mdl-layout__content section:not(:last-of-type){position:relative;margin-bottom:48px}.mdl-cssix section.section--center{max-width:860px}.mdl-cssix #features section.section--center{max-width:620px}.mdl-cssix section>header{display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-ms-flex-align:center;align-items:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center}.mdl-cssix section>.section__play-btn{min-height:200px}.mdl-cssix section>header>.material-icons{font-size:3rem}.mdl-cssix section>button{position:absolute;z-index:99;top:8px;right:8px}.mdl-cssix section .section__circle{display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-ms-flex-align:center;align-items:center;-webkit-justify-content:flex-start;-ms-flex-pack:start;justify-content:flex-start;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-shrink:1;-ms-flex-negative:1;flex-shrink:1}.mdl-cssix section .section__text{-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;padding-top:8px}.mdl-cssix section .section__text h5{font-size:inherit;margin:0;margin-bottom:.5em}.mdl-cssix section .section__text a{text-decoration:none}.mdl-cssix section .section__circle-container>.section__circle-container__circle{width:64px;height:64px;border-radius:32px;margin:8px 0}.mdl-cssix section.section--footer .section__circle--big{width:100px;height:100px;border-radius:50px;margin:8px 32px}.mdl-cssix .is-small-screen section.section--footer .section__circle--big{width:50px;height:50px;border-radius:25px;margin:8px 16px}.mdl-cssix section.section--footer{padding:64px 0;margin:0 -8px -8px -8px}.mdl-cssix section.section--center .section__text:not(:last-child){border-bottom:1px solid rgba(0,0,0,.13)}.mdl-cssix .mdl-card .mdl-card__supporting-text>h3:first-child{margin-bottom:24px}.mdl-cssix .mdl-layout__tab-panel:not(#overview){background-color:white}.mdl-cssix #features section{margin-bottom:72px}.mdl-cssix #features h4,#features h5{margin-bottom:16px}.mdl-cssix .toc{border-left:4px solid #C1EEF4;margin:24px;padding:0;padding-left:8px;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column}.mdl-cssix .toc h4{font-size:.9rem;margin-top:0}.mdl-cssix .toc a{color:#4DD0E1;text-decoration:none;font-size:16px;line-height:28px;display:block}.mdl-cssix .mdl-menu__container{z-index:99}.cssix-content{border-radius:2px;padding:80px 56px;margin-bottom:16px}.is-small-screen .cssix-content{padding:0 8px 16px 12px}.cssix-content a{color:#03a9f4!important}div.instructor{border:2px solid red;border-radius:12px;padding:10px}div.instructor::before{content:"Instructor Notes(The students will not see this content):";display:block;color:red;font-weight:bold}a.instructor-notes-link{color:green!important}div.unpublished{border:2px solid green;border-radius:12px;padding:10px;background-color:#deffd1}div.unpublished::before{content:"This content is not released to students yet";color:red;font-weight:bold}a.unpublished-link{color:red!important}a.next{float:right}.post-content img{width:50%;display:block;margin:auto}.post-content img.large_img{width:80%;display:block;margin:auto}.is-small-screen .mdl-layout__tab-bar-container{display:none}.mdl-layout.is-upgraded .mdl-layout__tab.is-active{color:yellow;font-weight:bold}.mdl-layout__tab.admin_link{background-color:#c71414}.mdl-layout__header .mdl-layout__drawer-button{color:yellow!important}. .mdl-mini-footer{border-top:1px solid #ccc;background-color:inherit!important;padding:8px 16px}footer .lockup{padding-left:15px;padding-top:10px}.lockup-logo,.lockup-text{display:inline-block}.va{vertical-align:middle;line-height:0}.lockup-logo{width:74px;height:24px;background-image:url(https://www.gstatic.com/images/branding/googlelogo/1x/googlelogo_color_74x24dp.png);background-size:74px 24px}.lockup-logo.lockup-dark{background-image:url(https://www.gstatic.com/images/branding/googlelogo/1x/googlelogo_dark_color_74x24dp.png);opacity:.54}@media(max-width:760px){footer .lockup{padding-top:0}}.answer{display:none;border:2px solid green;border-radius:12px;padding:1em}.hide_answer.mdl-button.mdl-js-button{display:none;!important}body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,hr,dl,dd,ol,ul,figure{margin:0;padding:0}body{font-family:Helvetica,Arial,sans-serif;font-size:16px;line-height:1.5;font-weight:300;color:#111;background-color:yellow;-webkit-text-size-adjust:100%}h1,h2,h3,h4,h5,h6,p,blockquote,pre,ul,ol,dl,figure,.highlight{margin-bottom:15px}img{max-width:100%;vertical-align:middle;display:block}figure>img{display:block}figcaption{font-size:14px}ul,ol{margin-left:30px}li>ul,li>ol{margin-bottom:0}h1,h2,h3,h4,h5,h6{font-weight:300}a{color:#2a7ae2;text-decoration:none}a:visited{color:#1756a9}a:hover{color:#111;text-decoration:underline}blockquote{color:#828282;border-left:4px solid #e8e8e8;padding-left:15px;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}pre,code{font-size:15px;border:1px solid #e8e8e8;border-radius:3px;background-color:#eef}code{padding:1px 5px}pre{padding:8px 12px;overflow-x:scroll}pre>code{border:0;padding-right:0;padding-left:0}.wrapper{max-width:-webkit-calc(800px -(30px * 2));max-width:calc(800px -(30px * 2));margin-right:auto;margin-left:auto;padding-right:30px;padding-left:30px}@media screen and (max-width:800px){.wrapper{max-width:-webkit-calc(800px -(30px));max-width:calc(800px -(30px));padding-right:15px;padding-left:15px}}.wrapper:after,.footer-col-wrapper:after{content:"";display:table;clear:both}.icon>svg{display:inline-block;width:16px;height:16px;vertical-align:middle}.icon>svg path{fill:#828282}.site-header{border-top:5px solid #424242;border-bottom:1px solid #e8e8e8;min-height:56px;position:relative}.site-title{font-size:26px;line-height:56px;letter-spacing:-1px;margin-bottom:0;float:left}.site-title,.site-title:visited{color:#424242}.sidebar-nav{float:left;border-right:1px solid #e8e8e8}.site-nav{float:right;line-height:56px}.site-nav .menu-icon{display:none}.site-nav .page-link{color:#111;line-height:1.5}.site-nav .page-link:not(:first-child){margin-left:20px}@media screen and (max-width:600px){.site-nav{position:absolute;top:9px;right:30px;background-color:yellow;border:1px solid #e8e8e8;border-radius:5px;text-align:right}.site-nav .menu-icon{display:block;float:right;width:36px;height:26px;line-height:0;padding-top:10px;text-align:center}.site-nav .menu-icon>svg{width:18px;height:15px}.site-nav .menu-icon>svg path{fill:#424242}.site-nav .trigger{clear:both;display:none}.site-nav:hover .trigger{display:block;padding-bottom:5px}.site-nav .page-link{display:block;padding:5px 10px}}.site-footer{border-top:1px solid #e8e8e8;padding:30px 0}.footer-heading{font-size:18px;margin-bottom:15px}.contact-list,.social-media-list{list-style:none;margin-left:0}.footer-col-wrapper{font-size:15px;color:#828282;margin-left:-15px}.footer-col{float:left;margin-bottom:15px;padding-left:15px}.footer-col-1{width:-webkit-calc(35% -(30px / 2));width:calc(35% -(30px / 2))}.footer-col-2{width:-webkit-calc(20% -(30px / 2));width:calc(20% -(30px / 2))}.footer-col-3{width:-webkit-calc(45% -(30px / 2));width:calc(45% -(30px / 2))}@media screen and (max-width:800px){.footer-col-1,.footer-col-2{width:-webkit-calc(50% -(30px / 2));width:calc(50% -(30px / 2))}.footer-col-3{width:-webkit-calc(100% -(30px / 2));width:calc(100% -(30px / 2))}}@media screen and (max-width:600px){.footer-col{float:none;width:-webkit-calc(100% -(30px / 2));width:calc(100% -(30px / 2))}}.page-content{padding:30px 0}.page-heading{font-size:20px}.post-list{margin-left:0;list-style:none;display:block;flex-wrap:wrap;justify-content:flex-start}.post-list>li{flex-basis:50%}.post-meta{font-size:14px;color:#828282}.post-link{display:block;font-size:1em}.post-header,.post-footer{margin-bottom:30px}.cssi-post-title{font-size:42px;letter-spacing:-1px;line-height:1}@media screen and (max-width:800px){.cssi-post-title{font-size:36px}}.cssix-intro h1{font-size:24px;line-height:1}.cssix-intro h2{font-size:16px;line-height:1}.post-content{margin-bottom:30px}.post-content h2{font-size:32px}@media screen and (max-width:800px){.post-content h2{font-size:28px}}.post-content h3{font-size:26px}@media screen and (max-width:800px){.post-content h3{font-size:22px}}.post-content h4{font-size:20px}@media screen and (max-width:800px){.post-content h4{font-size:18px}}.PageNavigation{font-size:14px;display:block;width:auto;overflow:hidden}.PageNavigation a{display:block;width:50%;float:left;margin:1em 0}.PageNavigation .next{text-align:right}.highlight .c{color:#998;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#998;font-style:italic}.highlight .cp{color:#999;font-weight:bold}.highlight .c1{color:#998;font-style:italic}.highlight .cs{color:#999;font-weight:bold;font-style:italic}.highlight .gd{color:#000;background-color:#fdd}.highlight .gd .x{color:#000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000;background-color:#dfd}.highlight .gi .x{color:#000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#458;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:#008080}.highlight .nb{color:#0086B3}.highlight .nc{color:#458;font-weight:bold}.highlight .no{color:#008080}.highlight .ni{color:#800080}.highlight .ne{color:#900;font-weight:bold}.highlight .nf{color:#900;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:#000080}.highlight .nv{color:#008080}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#d14}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#990073}.highlight .bp{color:#999}.highlight .vc{color:#008080}.highlight .vg{color:#008080}.highlight .vi{color:#008080}.highlight .il{color:#099}</style><link href="http://cssicurriculum.withgoogle.com/mvc-appEngine/datastore-query-relationship.html" rel="canonical"><link href="http://cssicurriculum.withgoogle.com/feed.xml" rel="alternate" title="Google CSSI" type="application/rss+xml"></head><body class="mdl-color--grey-100 mdl-color-text--grey-700 mdl-cssix" data-gr-c-s-loaded="true"><div class="mdl-layout__container has-scrolling-header"><div class="mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--no-desktop-drawer-button has-drawer is-small-screen has-tabs is-upgraded" data-upgraded=",MaterialLayout"><header class="mdl-layout__header mdl-layout__header--scroll mdl-color--primary mdl-color-text--white"><div aria-expanded="false" role="button" tabindex="0" class="mdl-layout__drawer-button"><i class="material-icons"></i></div><div class="mdl-layout--large-screen-only mdl-layout__header-row"></div><div class="mdl-layout__header-row"><a href="https://cssicurriculum.withgoogle.com/" id="cssilogo_header"></a></div><div class="mdl-layout--large-screen-only mdl-layout__header-row"></div><div class="mdl-layout__tab-bar-container"><div class="mdl-layout__tab-bar-button mdl-layout__tab-bar-left-button"><i class="material-icons">chevron_left</i></div><div class="mdl-layout--large-screen-only mdl-layout__tab-bar mdl-js-ripple-effect mdl-color--primary-dark mdl-color-text--white mdl-js-ripple-effect--ignore-events" data-upgraded=",MaterialRipple"><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/intro.html">Intro<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/command-line.html">Command Line<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/html.html">HTML &amp; CSS<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/javascript.html">JavaScript<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/python.html">Python<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab is-active" href="https://cssicurriculum.withgoogle.com/app-engine.html">AppEngine<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/project.html">Project Week<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/git.html">Git<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a><a class="mdl-layout__tab" href="https://cssicurriculum.withgoogle.com/resources.html">Resources<span class="mdl-layout__tab-ripple-container mdl-js-ripple-effect" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></a></div><div class="mdl-layout__tab-bar-button mdl-layout__tab-bar-right-button"><i class="material-icons">chevron_right</i></div></div></header><div class="mdl-layout__drawer" aria-hidden="true"><span class="mdl-layout-title">CSSIx Modules</span><nav class="mdl-navigation"><a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/intro.html">Intro</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/command-line.html">Command Line</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/html.html">HTML &amp; CSS</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/javascript.html">JavaScript</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/python.html">Python</a> <a class="mdl-navigation__link is-active" href="https://cssicurriculum.withgoogle.com/app-engine.html">AppEngine</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/project.html">Project Week</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/git.html">Git</a> <a class="mdl-navigation__link" href="https://cssicurriculum.withgoogle.com/resources.html">Resources</a></nav></div><main class="mdl-layout__content cssi-main"><div class="mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"></div><div class="cssix-content mdl-color--white mdl-shadow--4dp content mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><div class="post"><header class="post-header"><div><div class="PageNavigation"><a class="prev" href="https://cssicurriculum.withgoogle.com/mvc-appEngine/hogwarts.html">« Hogwarts Query App Lab</a> <a class="next" href="https://cssicurriculum.withgoogle.com/mvc-appEngine/appengine-starter-reference.html">Full Webapp Reference »</a></div></div></header><article class="post-content"><h1 id="datastore-queries-lecture-guide">Datastore Queries Lecture Guide</h1><h2 id="framing">Framing</h2><p></p><h3 id="learning-objectives">Learning objectives</h3><ul><li>Understand why it’s important for each Entity instance to have a unique key &amp; id</li><li>Apply the <code class="highlighter-rouge">query()</code> and <code class="highlighter-rouge">fetch()</code> methods in the correct contexts</li><li>Manipulate query results with <code class="highlighter-rouge">filter()</code> and <code class="highlighter-rouge">order()</code></li><li>Link entities together via the <code class="highlighter-rouge">ndb.KeyProperty</code></li></ul><h3 id="sequence">Sequence</h3><ol><li><a href="https://cssicurriculum.withgoogle.com/mvc-appEngine/datastore-query-relationship.html#querying-data">Querying Data</a></li><li><a href="https://cssicurriculum.withgoogle.com/mvc-appEngine/datastore-query-relationship.html#relationships-in-datastore">Relationships in Datastore</a></li></ol><h2 id="querying-data">Querying Data</h2><h4 id="describe-keys-and-ids">Describe Keys and IDs</h4><p>In the last lesson, we saw that each new <code class="highlighter-rouge">Movie</code> we created was stored with a unique ID and key, which were both autogenerated. The key is a very useful Python object that can be used to retrieve its associated Datastore Entity, and when you store an object with the <code class="highlighter-rouge">.put()</code> method, the key is returned for your convenience, in case you want to store it later. From that key, the id can be accessed. Look below for an example.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">ndb</span>

<span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">ndb</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

  <span class="n">media_type</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">"Movie"</span><span class="p">)</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">runtime</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">IntegerProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
  <span class="n">rating</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">FloatProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">autoplay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime</span><span class="o">&lt;=</span><span class="mi">120</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rating</span><span class="o">&gt;=</span><span class="mf">9.0</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">"Up Next: "</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"Search for More Movie Options"</span>

<span class="n">mean_girls</span> <span class="o">=</span> <span class="n">Movie</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">"Mean Girls"</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="mi">118</span><span class="p">,</span> <span class="n">rating</span><span class="o">=</span><span class="mf">8.7</span><span class="p">)</span>
<span class="n">mg_key</span> <span class="o">=</span> <span class="n">mean_girls</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">mg_key</span><span class="p">)</span>
<span class="n">mg_id</span> <span class="o">=</span> <span class="n">mg_key</span><span class="o">.</span><span class="nb">id</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">mg_id</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="the-query-class-vs-fetch">The Query Class vs Fetch</h4><p>In the Interactive Console, let’s explore why a method called <code class="highlighter-rouge">.fetch()</code> is needed.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c">##query vs fetch</span>
<span class="n">movies_query</span> <span class="o">=</span> <span class="n">Movie</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">movies_query</span><span class="p">)</span> <span class="c"># a query object</span>
<span class="n">all_movies</span> <span class="o">=</span> <span class="n">Movie</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span> <span class="c">#or movies_query.fetch()</span>
<span class="k">print</span><span class="p">(</span><span class="n">all_movies</span><span class="p">)</span> <span class="c"># the list found in response to that query</span>

<span class="c">##iteration</span>
<span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">all_movies</span><span class="p">:</span>
   <span class="k">print</span><span class="p">(</span><span class="n">movie</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="s">" is "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">movie</span><span class="o">.</span><span class="n">runtime</span><span class="p">)</span> <span class="o">+</span> <span class="s">" minutes long"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>In short, the <code class="highlighter-rouge">.query()</code> method simply creates a question - in this case “what movies are there?” - and the <code class="highlighter-rouge">.fetch()</code> method actually <em>asks</em> the question of Datastore.</p><p>Breaking this down into two steps may seem tedious at first, but as we come up with more advanced applications of these two methods, the separation may prove very helpful. We can create a query object (a question), but we don’t have to fetch the results (ask that question) right away.</p><h4 id="filtering-and-sorting-datastore-records">Filtering and Sorting Datastore Records</h4><p>One example of when you might need to break up the <code class="highlighter-rouge">.query()</code> and <code class="highlighter-rouge">.fetch()</code> methods is when you don’t want all the results. The <code class="highlighter-rouge">.filter()</code> and <code class="highlighter-rouge">.order()</code> methods can be used before the data is fetched.</p><p>The <code class="highlighter-rouge">.filter()</code> method:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c"># Only fetch movies with a title of "Black Panther".</span>
<span class="k">print</span><span class="p">(</span><span class="n">movies_query</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">Movie</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s">'Black Panther'</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">())</span>
<span class="c"># Only fetch movies longer than two hours.</span>
<span class="k">print</span><span class="p">(</span><span class="n">movies_query</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">Movie</span><span class="o">.</span><span class="n">runtime</span><span class="o">&gt;</span><span class="mi">120</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>The <code class="highlighter-rouge">.order()</code> method:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c"># Sort by rating.</span>
<span class="k">print</span><span class="p">(</span><span class="n">movies_query</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">Movie</span><span class="o">.</span><span class="n">rating</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">())</span>
<span class="c"># Use a negative sign to reverse the sort order.</span>
<span class="k">print</span><span class="p">(</span><span class="n">movies_query</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="o">-</span><span class="n">Movie</span><span class="o">.</span><span class="n">runtime</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>The <code class="highlighter-rouge">.fetch()</code> method can also take an optional numerical argument to limit the number of results:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># This still returns a list.</span>
<span class="n">best_movie</span> <span class="o">=</span> <span class="n">movies_query</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="o">-</span><span class="n">Movie</span><span class="o">.</span><span class="n">rating</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c"># Since fetch returns a list, you may want to use `[0]` to return the first</span>
<span class="c"># (and only) item in that list.</span>
<span class="k">print</span><span class="p">(</span><span class="n">best_movie</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div><h6 id="stretch-challenge-displaying-all-memes">Stretch Challenge: Displaying All Memes</h6><p>Practice querying the Datastore and displaying query results by adding a new page to your app that shows all of the submitted memes.</p><ul><li>Create a new handler and template to show all memes.</li><li>In <code class="highlighter-rouge">main.py</code>, query the Model class and pass the results of the query to the template.</li></ul><p></p><h2 id="relationships-in-datastore">Relationships in Datastore</h2><p>In this section we will practice defining relationships between Datastore entities.</p><p></p><h6 id="mini-challenges">Mini-challenges:</h6><ul><li>In the interactive console, create a new <em>Kind</em> (a new model) called <code class="highlighter-rouge">Student</code>.</li><li>Give the <code class="highlighter-rouge">Student</code> properties <code class="highlighter-rouge">grade</code>, <code class="highlighter-rouge">age</code>, <code class="highlighter-rouge">first_name</code>, and <code class="highlighter-rouge">last_name</code>.</li><li>Make each of those properties either an <code class="highlighter-rouge">ndb.IntegerProperty</code> or an <code class="highlighter-rouge">ndb.StringProperty</code>, and make them all required.</li><li>Create a student instance.</li><li>Add the student instance to your Datastore using the <code class="highlighter-rouge">.put()</code> method.</li></ul><p>Click to see an example of what that finished code might look like:</p><div class="answer_container"><div class="answer"><div></div><p></p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">ndb</span>

<span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="n">ndb</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">student_id</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">IntegerProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">harry</span> <span class="o">=</span> <span class="n">Student</span> <span class="p">(</span><span class="n">student_id</span><span class="o">=</span><span class="mi">423491782</span><span class="p">,</span> <span class="n">first_name</span> <span class="o">=</span><span class="s">"Harry"</span><span class="p">,</span> <span class="n">last_name</span> <span class="o">=</span> <span class="s">"Potter"</span><span class="p">)</span>
<span class="n">harry</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div><p></p></div><button class="show_answer mdl-button mdl-js-button mdl-button--primary" value="Show" data-upgraded=",MaterialButton">Show</button><button class="hide_answer mdl-button mdl-js-button mdl-button--accent" value="Hide" data-upgraded=",MaterialButton">Hide</button></div><p></p><p>There are three types of relationships we’re going to think about in this section:</p><ol><li>A <em>one-to-one</em> relationship is really just a single link - at Hogwarts, the best example of this might be a wand - each student has one and exactly one wand, and each wand belongs to exactly one owner.</li><li>A <em>one-to-many</em> relationship is best thought of as a list - at Hogwarts, the best example of this might be a House - each student belongs to one and only one House, but each House has many, many students.</li><li>A <em>many-to-many</em> relationship is perhaps the most different from anything we’ve put into code so far - at Hogwarts, the best example of this is a course. Each student might be enrolled in a whole set of courses, and each course might have a whole set of different students.</li></ol><h4 id="one-to-one">One to One</h4><p>Below is the implementation of a <code class="highlighter-rouge">Wand</code> class.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Wand</span><span class="p">(</span><span class="n">ndb</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">FloatProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">core</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">KeyProperty</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span>


<span class="n">ron</span> <span class="o">=</span> <span class="n">Student</span><span class="p">(</span><span class="n">student_id</span><span class="o">=</span><span class="mi">423491377</span><span class="p">,</span> <span class="n">first_name</span> <span class="o">=</span><span class="s">"Ron"</span><span class="p">,</span> <span class="n">last_name</span> <span class="o">=</span> <span class="s">"Weasley"</span><span class="p">)</span>

<span class="c"># Save key to use in relationship assignment later.</span>
<span class="n">ron_key</span> <span class="o">=</span> <span class="n">ron</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

<span class="c"># If you didn't have ron's key, you would search for it first.</span>
<span class="c"># ron_from_db = Student.query().filter(Student.first_name == 'Ron').fetch()</span>
<span class="c"># The `fetch()` method will always return a list, even when attempting to</span>
<span class="c"># fetch only one thing. It could end up returning an empty list, a list of 1, a</span>
<span class="c"># list of many.</span>
<span class="c"># ron_key = ron_from_db.key</span>

<span class="c"># Create a wand.</span>
<span class="c"># Since we've created owner to be a Student, we just pass in the key.</span>
<span class="n">ron_wand</span> <span class="o">=</span> <span class="n">Wand</span><span class="p">(</span><span class="n">length</span> <span class="o">=</span> <span class="mf">14.0</span><span class="p">,</span> <span class="n">material</span> <span class="o">=</span> <span class="s">"willow"</span><span class="p">,</span> <span class="n">core</span><span class="o">=</span><span class="s">"unicorn"</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="n">ron_key</span><span class="p">)</span>

<span class="n">ron_wand</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">ron_wand</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="using-keys">Using Keys</h4><p>You’ll notice that the <code class="highlighter-rouge">.owner</code> property is set to an <code class="highlighter-rouge">ndb.KeyProperty(Student)</code>; that means that the owner property isn’t a Student instance, but rather a key that can be used to access a Student instance.</p><p>Because of this setup, every wand will have an <code class="highlighter-rouge">.owner</code> property. That’s going to be really helpful if you have a wand object, but need to know who it belongs to. However, the <code class="highlighter-rouge">.owner</code> property of <code class="highlighter-rouge">ron_wand</code> doesn’t point directly to Ron. It points to his <em>key</em>. That means to access a wand’s owner’s name, you’ll need to <em>use that key</em> to access the <code class="highlighter-rouge">Student</code> instance associated to that key.</p><p>Let’s break this down in code:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c"># Assume that ron_wand is the same wand we created above.</span>
<span class="n">ron_key</span> <span class="o">=</span> <span class="n">ron_wand</span><span class="o">.</span><span class="n">owner</span> <span class="c"># Owner is just the key - not the student.</span>
<span class="n">ron</span> <span class="o">=</span> <span class="n">ron_key</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="c"># Use `.get()` to use the key to get the student.</span>
<span class="n">ron_name</span> <span class="o">=</span> <span class="n">ron</span><span class="o">.</span><span class="n">first_name</span> <span class="c"># Access ron's first_name property.</span>

<span class="c"># This could also be done in a single line of code.</span>
<span class="n">ron_name</span> <span class="o">=</span> <span class="n">ron_wand</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">first_name</span>

<span class="c"># So if you had an unknown wand, you could check its owner's name this way.</span>
<span class="k">print</span><span class="p">(</span><span class="n">some_wand</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="one-to-many">One to Many</h4><p>Below is the implementation of a <code class="highlighter-rouge">House</code> class.</p><p>Notice a few things:</p><ul><li>The <code class="highlighter-rouge">repeated=True</code> attribute of the KeyProperty is used in a way similar to the way our other properties have used <code class="highlighter-rouge">required</code>.<ul><li>By using <code class="highlighter-rouge">repeated=True</code>, we indicate that this property will be a Python list, not a single key.</li></ul></li><li>Since <code class="highlighter-rouge">students</code> is a repeated property and therefore a list, any key for a <code class="highlighter-rouge">Student</code> Entity can be appended to the list of keys.</li></ul><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">House</span><span class="p">(</span><span class="n">ndb</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="n">mascot</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
      <span class="n">students</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">KeyProperty</span><span class="p">(</span><span class="n">Student</span><span class="p">,</span> <span class="n">repeated</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="n">gryff</span> <span class="o">=</span> <span class="n">House</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Gryffindor"</span><span class="p">,</span> <span class="n">mascot</span><span class="o">=</span><span class="s">"Lion"</span><span class="p">,</span> <span class="n">students</span><span class="o">=</span><span class="p">[])</span>
<span class="n">gryff</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

<span class="c"># Create a student; be sure to store their key.</span>
<span class="n">hermione</span> <span class="o">=</span> <span class="n">Student</span><span class="p">(</span><span class="n">student_id</span><span class="o">=</span><span class="mi">423491249</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s">"Hermione"</span><span class="p">,</span>
                   <span class="n">last_name</span><span class="o">=</span><span class="s">"Granger"</span><span class="p">)</span>
<span class="n">hermione_key</span><span class="o">=</span><span class="n">hermione</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

<span class="c"># Use append to add students to the house.</span>
<span class="n">gryff</span><span class="o">.</span><span class="n">students</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hermione_key</span><span class="p">)</span>

<span class="c"># You can query for previous students.</span>
<span class="n">harry</span> <span class="o">=</span> <span class="n">Student</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">first_name</span><span class="o">==</span><span class="s">"Harry"</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">gryff</span><span class="o">.</span><span class="n">students</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">harry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">gryff</span><span class="o">.</span><span class="n">students</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="many-to-many">Many to Many</h4><p></p><p>Below is the implementation of a <code class="highlighter-rouge">Course</code> class.</p><p>You’ll notice that we’ve implemented an entirely separate class called an <code class="highlighter-rouge">Enrollment</code> that exists to manage the relationships that can exist between <code class="highlighter-rouge">Student</code> instances and <code class="highlighter-rouge">Course</code> instances. We manage this type of relationship a little bit differently, and rely a little more on the queries themselves on the <code class="highlighter-rouge">Enrollment</code> Kind when we need to see who is enrolled in what course.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Course</span><span class="p">(</span><span class="n">ndb</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="n">location</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Enrollment</span><span class="p">(</span><span class="n">ndb</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
      <span class="n">student</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">KeyProperty</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span>
      <span class="n">course</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">KeyProperty</span><span class="p">(</span><span class="n">Course</span><span class="p">)</span>

<span class="n">snapes_class</span> <span class="o">=</span> <span class="n">Course</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Potions"</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s">"dungeon"</span><span class="p">)</span>
<span class="n">dada</span> <span class="o">=</span> <span class="n">Course</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Defence Against the Dark Arts"</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s">"3C"</span><span class="p">)</span>
<span class="n">snapes_class_key</span> <span class="o">=</span> <span class="n">snapes_class</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
<span class="n">dada_key</span><span class="o">=</span><span class="n">dada</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

<span class="n">Enrollment</span><span class="p">(</span><span class="n">student</span><span class="o">=</span><span class="n">ron</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">course</span><span class="o">=</span><span class="n">dada_key</span><span class="p">)</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
<span class="n">Enrollment</span><span class="p">(</span><span class="n">student</span><span class="o">=</span><span class="n">harry</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">course</span><span class="o">=</span><span class="n">dada_key</span><span class="p">)</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
<span class="n">Enrollment</span><span class="p">(</span><span class="n">student</span><span class="o">=</span><span class="n">hermione</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">course</span><span class="o">=</span><span class="n">snapes_class_key</span><span class="p">)</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

<span class="k">print</span> <span class="n">Enrollment</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>It is unlikely that you’ll need this third type of relationship very early in your app development process, so don’t spend a lot of time trying to master this one just yet, but come back to it later - this third type is offered more as an FYI on your first run through.</p><p></p></article><footer class="post-footer"><hr><div class="PageNavigation"><a class="prev" href="https://cssicurriculum.withgoogle.com/mvc-appEngine/hogwarts.html">« Hogwarts Query App Lab</a> <a class="next" href="https://cssicurriculum.withgoogle.com/mvc-appEngine/appengine-starter-reference.html">Full Webapp Reference »</a></div></footer></div></div></div></main><footer class="mdl-mini-footer section"><div class="mdl-mini-footer__left-section"><div class="lockup va"><span class="lockup-logo lockup-dark"></span></div></div><div class="mdl-mini-footer__right-section"><ul class="mdl-mini-footer__link-list"><li><span id="site_label">CSSI - Atlanta</span></li><li>--</li><li><a href="https://www.google.com/intl/en/about/">About Google</a></li><li><a href="https://www.google.com/intl/en/policies/privacy/">Privacy</a></li><li><a href="https://www.google.com/intl/en/policies/terms/">Terms</a></li><li><a href="https://cssicurriculum.withgoogle.com/mvc-appEngine/datastore-query-relationship.html#" id="signout_link">Logout</a></li><li><a href="https://cssicurriculum.withgoogle.com/mvc-appEngine/datastore-query-relationship.html#" id="forgetme_link">Forget Me</a></li></ul></div><script src="./Datastore Queries Lecture Guide_files/firebase-app.js.download"></script><script src="./Datastore Queries Lecture Guide_files/firebase-auth.js.download"></script><script src="./Datastore Queries Lecture Guide_files/firebaseui.js.download"></script><link href="./Datastore Queries Lecture Guide_files/firebaseui.css" rel="stylesheet" type="text/css"><script>
  function getCookie(name) {
    let dc = document.cookie;
    let prefix = name + "=";
    let begin = dc.indexOf("; " + prefix);
    if (begin == -1) {
      begin = dc.indexOf(prefix);
      if (begin != 0) return null;
    }
    begin += 2;
    let end = document.cookie.indexOf(";", begin);
    if (end == -1) {
      end = dc.length;
    }
    return decodeURI(dc.substring(begin + prefix.length, end));
  }

  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyD_NpvZGlms1zebBgfE4RZPCim5irYGbG4",
    authDomain: "cssi-curriculum.firebaseapp.com",
    databaseURL: "https://cssi-curriculum.firebaseio.com",
    projectId: "cssi-curriculum",
    storageBucket: "cssi-curriculum.appspot.com",
    messagingSenderId: "443846997353"
  };
  // Firebase log-in widget
  function configureFirebaseLoginWidget() {
    let uiConfig = {
      signInSuccessUrl: '/',
      signInOptions: [
        // Leave the lines as is for the providers you want to offer your users.
        firebase.auth.GoogleAuthProvider.PROVIDER_ID,
        {
            provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
            // Whether the display name should be displayed in the Sign Up page.
            requireDisplayName: false,
        },
      ],
      callbacks: {
        signInSuccessWithAuthResult: function(authResult, redirectUrl) {
          let user = authResult.user;
          let credential = authResult.credential;
          let isNewUser = authResult.additionalUserInfo.isNewUser;
          let providerId = authResult.additionalUserInfo.providerId;
          let operationType = authResult.operationType;
          // Do something with the returned AuthResult.
          // Return type determines whether we continue the redirect automatically
          // or whether we leave that to developer to handle.
          return true;
        },
        signInFailure: function(error) {
          // Some unrecoverable error occurred during sign-in.
          // Return a promise when error handling is completed and FirebaseUI
          // will reset, clearing any UI. This commonly occurs for error code
          // 'firebaseui/anonymous-upgrade-merge-conflict' when merge conflict
          // occurs. Check below for more details on this.
          return handleUIError(error);
        },
      },
      // Terms of service url
      'tosUrl': 'https://www.google.com/intl/en/policies/terms/',
    };

    let user = firebase.auth().currentUser;
    if (!user && document.getElementById('firebaseui-auth-container')) {
      let ui = new firebaseui.auth.AuthUI(firebase.auth());
      ui.start('#firebaseui-auth-container', uiConfig);
    }
  }

  function updateUserToken(user) {
    let oldCookie = getCookie('idToken');
    if (user) {
      let refresh_token = getCookie('needRefreshToken');
      user.getIdToken(refresh_token == 'true').then(function(idToken) {
        document.cookie = "idToken=" + idToken + "; path=/";
        if (!oldCookie) {
          location.reload();
        }
      });
    } else {
      console.log("Removing auth token");
      document.cookie = "idToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC";
      if (oldCookie) {
        location.reload();
      }
    }
  }

  function configureFirebaseLogin() {
    firebase.initializeApp(config);
    firebase.auth().onAuthStateChanged(updateUserToken);
    firebase.auth().onIdTokenChanged(function() {console.log("token changed");});
  }

  function signOut() {
    firebase.auth().signOut();
    window.location = "/";
    return false;
  }

  function forgetMe() {
    let user = firebase.auth().currentUser;
    user.delete().then(function() {
      console.log("User deleted");
    }).catch(function(error) {
      console.log("Error deleting the user " + error);
    });
    firebase.auth().signOut();
    window.location = "/";
    return false;
  }

  function sendVerificationEmail() {
    let user = firebase.auth().currentUser;
    if (user && !user.emailVerified) {
      user.sendEmailVerification().then(function() {
          console.log("Verification email sent.");
        }).catch(function(error) {
          console.log("An error happened while sending the verification email.");
        });
    } else if (user) {
      console.log("Email already verified");
    } else {
      console.log("User not logged in");
    }
    console.log("Removing auth token");
    document.cookie = "idToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
    document.querySelector('#send_verification_button').style.display = 'None';
    document.querySelector('#verification_sent').style.display = 'block';
  }

  function checkAndRestoreCookie(){
    let user = firebase.auth().currentUser;
  }

  function showAnswer(event) {
    let show_answer_button = event.currentTarget;
    let answer_container = show_answer_button.parentElement;
    toggleAnswer(answer_container, true);
  }

  function hideAnswer(event) {
    let show_answer_button = event.currentTarget;
    let answer_container = show_answer_button.parentElement;
    toggleAnswer(answer_container, false);
  }

  function toggleAnswer(container, visible) {
    let answer = container.querySelector('.answer');
    answer.style.display = visible ? 'block' : 'none';
    let hide_answer_button = container.querySelector('.hide_answer');
    hide_answer_button.style.display = visible ? 'block' : 'none';
    let show_answer_button = container.querySelector('.show_answer');
    show_answer_button.style.display = visible ? 'none' : 'block';
  }

  function toggleStudentViewCookie(event) {
    const new_value = event.target.checked;
    document.cookie = "student_view=" + new_value + ";path=/";
    location.reload();
  }

  window.addEventListener('load', function() {
    configureFirebaseLogin();
    configureFirebaseLoginWidget();
    //checkAndRestoreCookie();
    let signout_link = document.querySelector('#signout_link');
    if (signout_link) {
      signout_link.onclick = signOut;
    }
    let forgetme_link = document.querySelector('#forgetme_link');
    if (forgetme_link) {
      forgetme_link.onclick = forgetMe;
    }
    let email_verification_btn = document.querySelector('#send_verification_button');
    if (email_verification_btn) {
      email_verification_btn.onclick = sendVerificationEmail;
    }
    let show_answer_btns = document.querySelectorAll('.show_answer');
    show_answer_btns.forEach( function(element) {
      element.onclick = showAnswer;
    });
    let hide_answer_btns = document.querySelectorAll('.hide_answer');
    hide_answer_btns.forEach( function(element) {
      element.onclick = hideAnswer;
    });
    // Student View checkbox not available on all pages, if present,
    // it can be used to override the user role, so that instructors can view
    // content as students.
    let student_view_flag = document.querySelector('#chk_student_view');
    if (student_view_flag) {
      student_view_flag.checked = JSON.parse(getCookie('student_view'));
      student_view_flag.onclick = toggleStudentViewCookie;
    }
    // Select the proper element in the site selection view based on the
    // existing cookies.
    let selected_site = getCookie('site');
    let site_selector_list = document.querySelectorAll('.site_radio');
    [].forEach.call(site_selector_list, (element) => {
      element.addEventListener('click', () => {
        console.log('Clicked ' + element.value);
        document.cookie = "site=" + element.value + ";path=/";
        document.querySelector('#site_label').innerText = element.dataset.label;
      });
    });
    if (selected_site && site_selector_list.length > 0) {
      [].forEach.call(site_selector_list, (element) => {
        console.log(selected_site);
        if (element.value === selected_site) {
          element.checked = true;
        } else {
          element.checked = false;
        }
      });
      console.log(site_selector_list);
    }

  })
</script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-101261509-1', 'auto');
  ga('send', 'pageview');
</script></footer><div class="mdl-layout__obfuscator"></div></div></div></body></html>